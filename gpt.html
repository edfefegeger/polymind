<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Polymind Arena</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { margin-top: 30px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #eee; }
    .green { color: green; }
    .red { color: red; }
#bubbleMap {
    position: relative;
    width: 100%;
    height: 500px;
    border: 1px solid #ccc;
    box-sizing: border-box;
}
#bubbleMap div {
    position: absolute;
    display: flex;
    justify-content: center;
    align-items: center;
    color: #fff;
    font-weight: bold;
    text-align: center;
    white-space: pre-line;
    box-sizing: border-box;
    border: 1px solid #fff;
    transition: all 0.5s ease;
}
</style>
</head>
<body>

<h1>Polymind Arena</h1>

<h2>–ú–æ–¥–µ–ª–∏ –∏ –±–∞–ª–∞–Ω—Å—ã</h2>
<table id="modelsTable">
    <thead>
        <tr>
            <th>Model</th><th>Balance</th><th>Wins</th><th>Total Bets</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<h2>–¢–µ–∫—É—â–µ–µ —Å–æ–±—ã—Ç–∏–µ</h2>
<div id="currentEvent"></div>

<h2>–ò—Å—Ç–æ—Ä–∏—è —Å–æ–±—ã—Ç–∏–π</h2>
<div id="eventHistory"></div>

<h2>–õ–∏–¥–µ—Ä–±–æ—Ä–¥</h2>
<table id="leaderboardTable">
    <thead>
        <tr>
            <th>Rank</th><th>Model</th><th>Balance</th><th>Return %</th><th>Win Rate</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<h2>Bubble Map</h2>
<div id="bubbleMap" style="width:100%;height:500px;border:1px solid #ccc;position:relative;"></div>

<h2>üí¨ AI Model Chat</h2>
<div style="max-width: 800px; background: #f9f9f9; padding: 20px; border-radius: 12px; border: 2px solid #ddd;">
    <div style="margin-bottom: 15px;">
        <label style="font-weight: bold; display: block; margin-bottom: 8px;">Select AI Model:</label>
        <select id="chatModel" style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-size: 14px;">
            <option value="gpt">ü§ñ GPT</option>
            <option value="claude">üß† Claude</option>
            <option value="gemini_pro">‚ú® Gemini Pro</option>
            <option value="grok">üòé Grok</option>
            <option value="deepseek">üîç DeepSeek</option>
            <option value="qwen_max">‚ö° Qwen Max</option>
        </select>
    </div>
    
    <div style="margin-bottom: 15px;">
        <label style="font-weight: bold; display: block; margin-bottom: 8px;">Your Question:</label>
        <textarea id="chatQuestion" placeholder="Ask about betting strategy, predictions, or analysis..." 
                  style="width: 100%; min-height: 80px; padding: 10px; border-radius: 8px; border: 2px solid #ccc; font-family: Arial; font-size: 14px; resize: vertical;"></textarea>
    </div>
    
    <button onclick="askModel()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s;">
        Send Message
    </button>
    
    <div id="chatAnswer" style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px; border: 2px solid #e0e0e0; min-height: 100px; max-height: 400px; overflow-y: auto; font-size: 14px; line-height: 1.6; white-space: pre-wrap; display: none;">
    </div>
    
    <div id="chatLoading" style="margin-top: 20px; padding: 15px; text-align: center; display: none;">
        <span style="font-size: 24px;">‚è≥</span>
        <p style="margin: 5px 0 0 0; color: #667eea;">AI is thinking...</p>
    </div>
</div>

<script>
const API = "http://localhost:8000";

// –•—Ä–∞–Ω–∏–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
let lastModelsState = null;

// -------------------------
// Fetch Models
// -------------------------
async function fetchModels() {
    const res = await fetch(`${API}/models`);
    const models = await res.json();
    const tbody = document.querySelector("#modelsTable tbody");
    tbody.innerHTML = "";
    models.forEach(m => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${m.name}</td>
                        <td>${m.balance.toFixed(2)}</td>
                        <td>${m.wins}</td>
                        <td>${m.total_bets}</td>`;
        tbody.appendChild(tr);
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º bubble map –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –º–æ–¥–µ–ª–µ–π
    updateBubbleMapFromModels(models);
}

// -------------------------
// Update Bubble Map from Models
// -------------------------
function updateBubbleMapFromModels(models) {
    const items = models.map(m => ({
        model: m.name,
        balance: m.balance,
        delta: m.balance - 10000
    }));
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –ª–∏ –¥–∞–Ω–Ω—ã–µ
    const currentState = JSON.stringify(items.map(i => ({n: i.model, b: i.balance})));
    if (lastModelsState === currentState) {
        return; // –î–∞–Ω–Ω—ã–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å, –Ω–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
    }
    
    lastModelsState = currentState;
    renderTreemap(items);
}

// -------------------------
// Fetch Current Event
// -------------------------
async function fetchCurrentEvent() {
    const res = await fetch(`${API}/events/current`);
    const event = await res.json();
    const div = document.getElementById("currentEvent");
    if(event){
        let html = `<b>ID:</b> ${event.id} <br><b>${event.description}</b><br>`;
        html += "<table><tr><th>Model</th><th>Side</th><th>Amount</th></tr>";
        event.bets.forEach(b => {
            html += `<tr><td>${b.model_id}</td><td>${b.side}</td><td>${b.amount}</td></tr>`;
        });
        html += "</table>";
        div.innerHTML = html;
    } else div.innerHTML = "No active event";
}

// -------------------------
// Fetch Event History
// -------------------------
async function fetchEventHistory() {
    const res = await fetch(`${API}/events/history`);
    const events = await res.json();
    const div = document.getElementById("eventHistory");
    let html = "";
    events.forEach(e => {
        html += `<b>${e.id}: ${e.description} [${e.result}]</b><br>`;
    });
    div.innerHTML = html;
}

// -------------------------
// Fetch Leaderboard
// -------------------------
async function fetchLeaderboard() {
    const res = await fetch(`${API}/leaderboard`);
    const data = await res.json();
    const tbody = document.querySelector("#leaderboardTable tbody");
    tbody.innerHTML = "";
    data.forEach(d => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${d.rank}</td><td>${d.model}</td><td>${d.balance.toFixed(2)}</td><td>${d.return_percent.toFixed(2)}</td><td>${d.win_rate.toFixed(1)}</td>`;
        tbody.appendChild(tr);
    });
}

// -------------------------
// Bubble Map WebSocket
// -------------------------
const ws = new WebSocket("ws://localhost:8000/ws/bubble-map");

ws.onmessage = (msg) => {
    const data = JSON.parse(msg.data);
    if(data.type === "bubble_map") {
        renderTreemap(data.data);
    }
}

// -------------------------
// Model Chat
// -------------------------
async function askModel() {
    const model_id = document.getElementById("chatModel").value;
    const question = document.getElementById("chatQuestion").value.trim();
    
    if (!question) {
        alert("Please enter a question!");
        return;
    }
    
    // Show loading, hide answer
    document.getElementById("chatLoading").style.display = "block";
    document.getElementById("chatAnswer").style.display = "none";
    
    try {
        const res = await fetch(`${API}/model-chat`, {
            method: "POST",
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({model_id, question})
        });
        
        const data = await res.json();
        
        // Hide loading, show answer
        document.getElementById("chatLoading").style.display = "none";
        const answerDiv = document.getElementById("chatAnswer");
        answerDiv.style.display = "block";
        answerDiv.innerText = data.answer;
        
    } catch (error) {
        document.getElementById("chatLoading").style.display = "none";
        document.getElementById("chatAnswer").style.display = "block";
        document.getElementById("chatAnswer").innerText = "Error: " + error.message;
    }
}

function renderTreemap(items){
    const container = document.getElementById("bubbleMap");
    container.innerHTML = "";
    const W = container.clientWidth;
    const H = container.clientHeight;

    // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –¥–ª—è —Ö–∞–æ—Ç–∏—á–Ω–æ—Å—Ç–∏
    items = items.sort(()=>Math.random()-0.5);

    function layout(x, y, w, h, data){
        if(data.length === 0) return;

        if(data.length === 1){
            const item = data[0];
            const div = document.createElement("div");
            div.style.position = "absolute";
            div.style.left = `${x}px`;
            div.style.top = `${y}px`;
            div.style.width = `${w}px`;
            div.style.height = `${h}px`;
            div.style.background = item.balance < 10000 ? "red" : "green";
            div.style.color = "#fff";
            div.style.display = "flex";
            div.style.justifyContent = "center";
            div.style.alignItems = "center";
            div.style.fontWeight = "bold";
            div.style.textAlign = "center";
            div.style.fontSize = "12px";
            div.innerText = `${item.model}\n$${item.balance.toFixed(0)}`;
            container.appendChild(div);
            return;
        }

        // —Å–ª—É—á–∞–π–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–µ–ª–µ–Ω–∏—è
        const horizontal = Math.random() > 0.5;

        // —Å–ª—É—á–∞–π–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞: –æ—Ç 30% –¥–æ 70%, –Ω–æ –Ω–µ –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–º 1 —ç–ª–µ–º–µ–Ω—Ç
        let minSplit = Math.max(1, Math.floor(0.3 * data.length));
        let maxSplit = Math.min(data.length - 1, Math.floor(0.7 * data.length));
        if(maxSplit <= minSplit) maxSplit = minSplit + 1;
        const splitIndex = Math.floor(minSplit + Math.random() * (maxSplit - minSplit));

        const first = data.slice(0, splitIndex);
        const rest = data.slice(splitIndex);

        // –±–∞–ª–∞–Ω—Å –ø–µ—Ä–≤–æ–π –∏ –≤—Ç–æ—Ä–æ–π –≥—Ä—É–ø–ø—ã
        const firstTotal = first.reduce((sum,i)=>sum+i.balance,0);
        const restTotal = rest.reduce((sum,i)=>sum+i.balance,0);
        const total = firstTotal + restTotal;

        if(horizontal){
            const w1 = w * (firstTotal/total) * (0.8 + Math.random()*0.4);
            const w2 = w - w1;
            layout(x, y, w1, h, first);
            layout(x + w1, y, w2, h, rest);
        } else {
            const h1 = h * (firstTotal/total) * (0.8 + Math.random()*0.4);
            const h2 = h - h1;
            layout(x, y, w, h1, first);
            layout(x, y + h1, w, h2, rest);
        }
    }

    layout(0, 0, W, H, items);
}

async function refreshAll() {
    await fetchModels();
    await fetchCurrentEvent();
    await fetchEventHistory();
    await fetchLeaderboard();
}
setInterval(refreshAll, 5000);
refreshAll();

</script>

</body>
</html>