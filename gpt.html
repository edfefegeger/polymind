<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Polymind Arena</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { margin-top: 30px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #eee; }
    .green { color: green; }
    .red { color: red; }
#bubbleMap {
    position: relative;
    width: 100%;
    height: 500px;
    border: 1px solid #ccc;
    box-sizing: border-box;
}
#bubbleMap div {
    position: absolute;
    display: flex;
    justify-content: center;
    align-items: center;
    color: #fff;
    font-weight: bold;
    text-align: center;
    white-space: pre-line;
    box-sizing: border-box;
    border: 1px solid #fff;
    transition: all 0.5s ease;
}
</style>
</head>
<body>

<h1>Polymind Arena</h1>

<h2>Модели и балансы</h2>
<table id="modelsTable">
    <thead>
        <tr>
            <th>Model</th><th>Balance</th><th>Wins</th><th>Total Bets</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<h2>Текущее событие</h2>
<div id="currentEvent"></div>

<h2>История событий</h2>
<div id="eventHistory"></div>

<h2>Лидерборд</h2>
<table id="leaderboardTable">
    <thead>
        <tr>
            <th>Rank</th><th>Model</th><th>Balance</th><th>Return %</th><th>Win Rate</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<h2>Bubble Map</h2>
<div id="bubbleMap" style="width:100%;height:500px;border:1px solid #ccc;position:relative;"></div>

<h2>Model Chat</h2>
<select id="chatModel">
    <option value="gpt_5">GPT-5</option>
    <option value="claude">Claude</option>
    <option value="sonnet_4_5">Sonnet 4.5</option>
    <option value="gemini_2_5_pro">Gemini 2.5 Pro</option>
    <option value="grok_4">Grok 4</option>
    <option value="deepseek_v3_1">DeepSeek V3.1</option>
    <option value="qwen3_max">Qwen3 Max</option>
</select>
<input type="text" id="chatQuestion" placeholder="Your question">
<button onclick="askModel()">Ask</button>
<div id="chatAnswer"></div>

<script>
const API = "http://localhost:8000";

// Храним последнее состояние для сравнения
let lastModelsState = null;

// -------------------------
// Fetch Models
// -------------------------
async function fetchModels() {
    const res = await fetch(`${API}/models`);
    const models = await res.json();
    const tbody = document.querySelector("#modelsTable tbody");
    tbody.innerHTML = "";
    models.forEach(m => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${m.name}</td>
                        <td>${m.balance.toFixed(2)}</td>
                        <td>${m.wins}</td>
                        <td>${m.total_bets}</td>`;
        tbody.appendChild(tr);
    });
    
    // Обновляем bubble map при обновлении моделей
    updateBubbleMapFromModels(models);
}

// -------------------------
// Update Bubble Map from Models
// -------------------------
function updateBubbleMapFromModels(models) {
    const items = models.map(m => ({
        model: m.name,
        balance: m.balance,
        delta: m.balance - 10000
    }));
    
    // Проверяем, изменились ли данные
    const currentState = JSON.stringify(items.map(i => ({n: i.model, b: i.balance})));
    if (lastModelsState === currentState) {
        return; // Данные не изменились, не перерисовываем
    }
    
    lastModelsState = currentState;
    renderTreemap(items);
}

// -------------------------
// Fetch Current Event
// -------------------------
async function fetchCurrentEvent() {
    const res = await fetch(`${API}/events/current`);
    const event = await res.json();
    const div = document.getElementById("currentEvent");
    if(event){
        let html = `<b>ID:</b> ${event.id} <br><b>${event.description}</b><br>`;
        html += "<table><tr><th>Model</th><th>Side</th><th>Amount</th></tr>";
        event.bets.forEach(b => {
            html += `<tr><td>${b.model_id}</td><td>${b.side}</td><td>${b.amount}</td></tr>`;
        });
        html += "</table>";
        div.innerHTML = html;
    } else div.innerHTML = "No active event";
}

// -------------------------
// Fetch Event History
// -------------------------
async function fetchEventHistory() {
    const res = await fetch(`${API}/events/history`);
    const events = await res.json();
    const div = document.getElementById("eventHistory");
    let html = "";
    events.forEach(e => {
        html += `<b>${e.id}: ${e.description} [${e.result}]</b><br>`;
    });
    div.innerHTML = html;
}

// -------------------------
// Fetch Leaderboard
// -------------------------
async function fetchLeaderboard() {
    const res = await fetch(`${API}/leaderboard`);
    const data = await res.json();
    const tbody = document.querySelector("#leaderboardTable tbody");
    tbody.innerHTML = "";
    data.forEach(d => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${d.rank}</td><td>${d.model}</td><td>${d.balance.toFixed(2)}</td><td>${d.return_percent.toFixed(2)}</td><td>${d.win_rate.toFixed(1)}</td>`;
        tbody.appendChild(tr);
    });
}

// -------------------------
// Bubble Map WebSocket
// -------------------------
const ws = new WebSocket("ws://localhost:8000/ws/bubble-map");

ws.onmessage = (msg) => {
    const data = JSON.parse(msg.data);
    if(data.type === "bubble_map") {
        renderTreemap(data.data);
    }
}

// -------------------------
// Model Chat
// -------------------------
async function askModel() {
    const model_id = document.getElementById("chatModel").value;
    const question = document.getElementById("chatQuestion").value;
    const res = await fetch(`${API}/model-chat`, {
        method: "POST",
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({model_id, question})
    });
    const data = await res.json();
    document.getElementById("chatAnswer").innerText = data.answer;
}

function renderTreemap(items){
    const container = document.getElementById("bubbleMap");
    container.innerHTML = "";
    const W = container.clientWidth;
    const H = container.clientHeight;

    // Перемешиваем для хаотичности
    items = items.sort(()=>Math.random()-0.5);

    function layout(x, y, w, h, data){
        if(data.length === 0) return;

        if(data.length === 1){
            const item = data[0];
            const div = document.createElement("div");
            div.style.position = "absolute";
            div.style.left = `${x}px`;
            div.style.top = `${y}px`;
            div.style.width = `${w}px`;
            div.style.height = `${h}px`;
            div.style.background = item.balance < 10000 ? "red" : "green";
            div.style.color = "#fff";
            div.style.display = "flex";
            div.style.justifyContent = "center";
            div.style.alignItems = "center";
            div.style.fontWeight = "bold";
            div.style.textAlign = "center";
            div.style.fontSize = "12px";
            div.innerText = `${item.model}\n$${item.balance.toFixed(0)}`;
            container.appendChild(div);
            return;
        }

        // случайное направление деления
        const horizontal = Math.random() > 0.5;

        // случайное разделение массива: от 30% до 70%, но не оставляем последним 1 элемент
        let minSplit = Math.max(1, Math.floor(0.3 * data.length));
        let maxSplit = Math.min(data.length - 1, Math.floor(0.7 * data.length));
        if(maxSplit <= minSplit) maxSplit = minSplit + 1;
        const splitIndex = Math.floor(minSplit + Math.random() * (maxSplit - minSplit));

        const first = data.slice(0, splitIndex);
        const rest = data.slice(splitIndex);

        // баланс первой и второй группы
        const firstTotal = first.reduce((sum,i)=>sum+i.balance,0);
        const restTotal = rest.reduce((sum,i)=>sum+i.balance,0);
        const total = firstTotal + restTotal;

        if(horizontal){
            const w1 = w * (firstTotal/total) * (0.8 + Math.random()*0.4);
            const w2 = w - w1;
            layout(x, y, w1, h, first);
            layout(x + w1, y, w2, h, rest);
        } else {
            const h1 = h * (firstTotal/total) * (0.8 + Math.random()*0.4);
            const h2 = h - h1;
            layout(x, y, w, h1, first);
            layout(x, y + h1, w, h2, rest);
        }
    }

    layout(0, 0, W, H, items);
}

async function refreshAll() {
    await fetchModels();
    await fetchCurrentEvent();
    await fetchEventHistory();
    await fetchLeaderboard();
}
setInterval(refreshAll, 5000);
refreshAll();

</script>

</body>
</html>