<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Events Admin ‚Äî Manage Betting Events</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#0b1220;color:#e6eef8;padding:20px}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px}
  h2{color:#64ffda;margin:0}
  .back-btn{padding:10px 20px;background:#667eea;color:white;border:none;border-radius:8px;cursor:pointer;text-decoration:none;display:inline-block}
  .back-btn:hover{background:#7a8cff}
  .card{background:#0f1a2b;padding:20px;border-radius:12px;margin-bottom:20px;border:1px solid rgba(255,255,255,0.08)}
  label{display:block;margin-top:12px;font-size:13px;color:#9fb0d6;font-weight:600}
  input,select,textarea{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:#071025;color:#e6eef8;width:100%;font-family:inherit;margin-top:6px}
  textarea{resize:vertical;min-height:60px}
  button{margin-top:12px;padding:12px 18px;border-radius:8px;border:none;background:linear-gradient(135deg,#43e97b 0%,#38f9d7 100%);color:white;cursor:pointer;font-weight:600;transition:all 0.3s}
  button:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(67,233,123,0.4)}
  button.danger{background:linear-gradient(135deg,#ff6b6b 0%,#ee5a6f 100%)}
  button.warning{background:linear-gradient(135deg,#feca57 0%,#ff9ff3 100%)}
  table{width:100%;border-collapse:collapse;margin-top:16px}
  th,td{padding:12px;border-bottom:1px solid rgba(255,255,255,0.05);text-align:left}
  th{color:#64ffda;font-weight:600;font-size:13px;text-transform:uppercase}
  td{color:#dbe9ff;font-size:14px}
  .status-badge{padding:4px 10px;border-radius:12px;font-size:11px;font-weight:700;text-transform:uppercase;display:inline-block}
  .status-upcoming{background:rgba(255,206,84,0.2);color:#ffce54}
  .status-active{background:rgba(100,255,218,0.2);color:#64ffda}
  .status-finished{background:rgba(136,146,176,0.2);color:#8892b0}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .actions button{margin:0;padding:6px 12px;font-size:12px}
  .small{font-size:12px;color:#93a7cf;margin-top:4px}
</style>
</head>
<body>
  <div class="header">
    <h2>‚öôÔ∏è Events Administration</h2>
    <a href="index.html" class="back-btn">‚Üê Back to Dashboard</a>
  </div>

  <div class="card">
    <h3>‚ûï Create New Event</h3>
    <label>Event Title *
      <input id="eventTitle" type="text" placeholder="Will Bitcoin drop by 1% in 10 minutes?" />
    </label>
    <label>Description (optional)
      <textarea id="eventDescription" placeholder="Market prediction event..."></textarea>
    </label>
    <label>Duration (minutes)
      <input id="eventDuration" type="number" value="10" min="1" max="1440" />
      <div class="small">How long before the event resolves (1-1440 minutes)</div>
    </label>
    <button onclick="createNewEvent()">Create Event</button>
  </div>

  <div class="card">
    <h3>üìã All Events</h3>
    <button onclick="loadEvents()">üîÑ Refresh List</button>
    <table id="eventsTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Title</th>
          <th>Duration</th>
          <th>Status</th>
          <th>Pools</th>
          <th>Winner</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
const API = "http://localhost:8000";

async function safeJson(res){
  const text = await res.text();
  if(!text) return {};
  try{return JSON.parse(text);}
  catch(e){console.error("Bad JSON:",text);throw e;}
}

async function createNewEvent() {
  const description = document.getElementById("eventTitle").value.trim();
  const duration = parseInt(document.getElementById("eventDuration").value);

  if (!description) { alert("Title is required"); return; }

  const res = await fetch(`${API}/events`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({description, duration_minutes: duration})
  });

  await safeJson(res);
  alert("Event created!");
  loadEvents();
}

async function loadEvents(){
  try{
    const res = await fetch(`${API}/events/history`);
    const events = await safeJson(res);
    const tbody = document.querySelector('#eventsTable tbody');
    tbody.innerHTML = '';

    if(!Array.isArray(events)||events.length===0){
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#8892b0">No events found</td></tr>';
      return;
    }

    events.forEach(ev => {
      const totalYes = ev.total_yes||0;
      const totalNo = ev.total_no||0;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${ev.id}</td>
        <td>${ev.description}</td>
        <td>${Math.round((new Date(ev.end_time)-new Date(ev.start_time))/60000)} min</td>
        <td><span class="status-badge status-${ev.status}">${ev.status}</span></td>
        <td>${ev.status==='active' ? `YES: $${totalYes}<br>NO: $${totalNo}` : '-'}</td>
        <td>${ev.result||'-'}</td>
        <td class="actions">
          ${ev.status==='active' ? `
            <button class="warning" onclick="resolveEvent(${ev.id}, 'YES')">YES</button>
            <button class="warning" onclick="resolveEvent(${ev.id}, 'NO')">NO</button>` : ''}
        </td>
      `;
      tbody.appendChild(tr);
    });
  }catch(e){console.error(e);alert('Error loading events');}
}

async function resolveEvent(id, side){
  if(!confirm(`Resolve event with ${side} as winner?`)) return;
  try{
    await fetch(`${API}/events/${id}/result`,{
      method:'PATCH',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({result:side})
    });
    alert(`Event ${id} resolved as ${side}`);
    loadEvents();
  }catch(e){console.error(e);alert('Error resolving event');}
}

// --- Init ---
loadEvents();
setInterval(loadEvents,5000); // –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫
</script>

</body>
</html>
